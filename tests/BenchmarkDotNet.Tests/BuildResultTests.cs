using BenchmarkDotNet.Toolchains;
using BenchmarkDotNet.Toolchains.Results;
using JetBrains.Annotations;
using System;
using Xunit;

namespace BenchmarkDotNet.Tests
{
    public class BuildResultTests
    {
        [Fact]
        public void NotFullyCompatibileMsBuildErrorIsTranslatedToMoreUserFriendlyVersion()
        {
            const string msbuildError = @"C:\Program Files\dotnet\sdk\3.0.100-preview9-013617\Microsoft.Common.CurrentVersion.targets(1653,5): warning NU1702: ProjectReference 'C:\Projects\BenchmarkDotNet\tests\BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetFramework\BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetFramework.csproj' was resolved using '.NETFramework,Version=v4.6.1' instead of the project target framework '.NETCoreApp,Version=v2.1'. This project may not be fully compatible with your project. [C:\Projects\BenchmarkDotNet\tests\BenchmarkDotNet.IntegrationTests\bin\Release\net461\Job-VUALUD\BenchmarkDotNet.Autogenerated.csproj]";

            string expected = @"The project which defines benchmarks targets 'net461', you can not benchmark 'netcoreapp2.1'." + Environment.NewLine +
                "To be able to benchmark 'netcoreapp2.1' you need to use <TargetFrameworks>net461;netcoreapp2.1</TargetFrameworks> in your project file " +
                @"('C:\Projects\BenchmarkDotNet\tests\BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetFramework\BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetFramework.csproj').";

            Verify(msbuildError, true, expected);
        }

        [Fact]
        public void NotCompatibileMsBuildErrorIsTranslatedToMoreUserFriendlyVersion()
        {
            const string msbuildError = @"error NU1201: Project BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetCore is not compatible with net461 (.NETFramework,Version=v4.6.1) / win7-x64. Project BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetCore supports: netcoreapp2.1 (.NETCoreApp,Version=v2.1)";

            string expected = @"The project which defines benchmarks targets 'netcoreapp2.1', you can not benchmark 'net461'." + Environment.NewLine +
                "To be able to benchmark 'net461' you need to use <TargetFrameworks>netcoreapp2.1;net461</TargetFrameworks> in your project file " +
                @"('BenchmarkDotNet.IntegrationTests.SingleRuntime.DotNetCore').";

            Verify(msbuildError, true, expected);
        }

        [Fact]
        public void UnknownMSBuildErrorsAreNotTranslatedToMoreUserFriendlyVersions()
        {
            const string msbuildError = "warning NU1702: something is broken";

            Verify(msbuildError, false, null);
        }

        [AssertionMethod]
        private void Verify(string msbuildError, bool expectedResult, string expectedReason)
        {
            var sut = BuildResult.Failure(GenerateResult.Success(ArtifactsPaths.Empty, Array.Empty<string>()), msbuildError);

            Assert.Equal(expectedResult, sut.TryToExplainFailureReason(out string reason));
            Assert.Equal(expectedReason, reason);
        }
    }
}
