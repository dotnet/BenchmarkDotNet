<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Sample: IntroPercentiles | BenchmarkDotNet </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Sample: IntroPercentiles | BenchmarkDotNet ">
      
      <link rel="icon" href="../../logo/icon-32.png">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/dotnet/BenchmarkDotNet/blob/docs-stable/docs/articles/samples/IntroPercentiles.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
  </head>

  <script type="module" src="./../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo/icon.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="BenchmarkDotNet.Samples.IntroPercentiles">
<h2 id="sample-intropercentiles">Sample: IntroPercentiles</h2>

<p>The percentile represents a higher boundary for specified percentage of the measurements.
For example, 95th percentile = 500ms means that 95% of all samples are not slower than 500ms.
This metric is not very useful in microbenchmarks, as the values from consequent runs have a very narrow distribution.
However, real-world scenarios often have so-called long tail distribution
(due to IO delays, locks, memory access latency and so on), so the average execution time cannot be trusted.</p>
<p>The percentiles allow to include the tail of distribution into the comparison.
However, it requires some preparations steps.
At first, you should have enough runs to count percentiles from.
The <code>IterationCount</code> in the config should be set to 10-20 runs at least.</p>
<p>Second, the count of iterations for each run should not be very high, or the peak timings will be averaged.
The <code>IterationTime = 25</code> works fine for most cases;
for long-running benchmarks the <code>Mode = Mode.SingleRun</code> will be the best choice.
However, feel free to experiment with the config values.</p>
<p>Third, if you want to be sure that measurements are repeatable, set the <code>LaunchCount</code> to 3 or higher.</p>
<p>And last, don't forget to include the columns into the config.
They are not included by default (as said above, these are not too useful for most of the benchmarks).
There're predefined <code>StatisticColumn.P0</code>..<code>StatisticColumn.P100</code> for absolute timing percentiles.</p>
<h3 id="example">Example</h3>
<p>Run the IntroPercentiles sample. It contains three benchmark methods.</p>
<ul>
<li>First delays for 20 ms constantly.</li>
<li>The second has random delays for 10..30 ms.</li>
<li>And the third delays for 10ms 85 times of 100 and delays for 40ms 15 times of 100.</li>
</ul>
<p>Here's the output from the benchmark (some columns removed for brevity):</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Median</th>
<th>StdDev</th>
<th>Ratio</th>
<th>P0</th>
<th>P50</th>
<th>P80</th>
<th>P85</th>
<th>P95</th>
<th>P100</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConstantDelays</td>
<td>20.3813 ms</td>
<td>0.2051 ms</td>
<td>1.00</td>
<td>20.0272 ms</td>
<td>20.3813 ms</td>
<td>20.4895 ms</td>
<td>20.4954 ms</td>
<td>20.5869 ms</td>
<td>21.1471 ms</td>
</tr>
<tr>
<td>RandomDelays</td>
<td>19.8055 ms</td>
<td>5.7556 ms</td>
<td>0.97</td>
<td>10.0793 ms</td>
<td>19.8055 ms</td>
<td>25.4173 ms</td>
<td>26.5187 ms</td>
<td>29.0313 ms</td>
<td>29.4550 ms</td>
</tr>
<tr>
<td>RareDelays</td>
<td>10.3385 ms</td>
<td>11.4828 ms</td>
<td>0.51</td>
<td>10.0157 ms</td>
<td>10.3385 ms</td>
<td>10.5211 ms</td>
<td>40.0560 ms</td>
<td>40.3992 ms</td>
<td>40.4674 ms</td>
</tr>
</tbody>
</table>
<p>Also, it's very easy to screw the results with incorrect setup. For example, the same code being run with</p>
<pre><code class="lang-cs">new Job
{
	IterationCount = 5,
	IterationTime = 500
}
</code></pre>
<p>completely hides the peak values:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Median</th>
<th>StdDev</th>
<th>Ratio</th>
<th>P0</th>
<th>P50</th>
<th>P80</th>
<th>P85</th>
<th>P95</th>
<th>P100</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConstantDelays</td>
<td>20.2692 ms</td>
<td>0.0308 ms</td>
<td>1.00</td>
<td>20.1986 ms</td>
<td>20.2692 ms</td>
<td>20.2843 ms</td>
<td>20.2968 ms</td>
<td>20.3097 ms</td>
<td>20.3122 ms</td>
</tr>
<tr>
<td>RandomDelays</td>
<td>18.9965 ms</td>
<td>0.8601 ms</td>
<td>0.94</td>
<td>18.1339 ms</td>
<td>18.9965 ms</td>
<td>19.8126 ms</td>
<td>19.8278 ms</td>
<td>20.4485 ms</td>
<td>20.9466 ms</td>
</tr>
<tr>
<td>RareDelays</td>
<td>14.0912 ms</td>
<td>2.8619 ms</td>
<td>0.70</td>
<td>10.2606 ms</td>
<td>14.0912 ms</td>
<td>15.7653 ms</td>
<td>17.3862 ms</td>
<td>18.6728 ms</td>
<td>18.6940 ms</td>
</tr>
</tbody>
</table>
<h3 id="source-code">Source code</h3>
<pre><code class="lang-csharp" name="IntroPercentiles.cs">using System;
using System.Threading;
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Columns;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Engines;

namespace BenchmarkDotNet.Samples
{
    // Using percentiles for adequate timings representation
    [Config(typeof(Config))]
    [SimpleJob(RunStrategy.ColdStart, launchCount: 4,
        warmupCount: 3, iterationCount: 20, id: &quot;MyJob&quot;)]
    public class IntroPercentiles
    {
        // To share between runs.
        // DO NOT do this in production code. The System.Random IS NOT thread safe.
        private static readonly Random Rnd = new Random();

        private class Config : ManualConfig
        {
            public Config()
            {
                AddColumn(
                    StatisticColumn.P0,
                    StatisticColumn.P25,
                    StatisticColumn.P50,
                    StatisticColumn.P67,
                    StatisticColumn.P80,
                    StatisticColumn.P85,
                    StatisticColumn.P90,
                    StatisticColumn.P95,
                    StatisticColumn.P100);
            }
        }

        [Benchmark(Baseline = true)]
        public void ConstantDelays() =&gt; Thread.Sleep(20);

        [Benchmark]
        public void RandomDelays() =&gt; Thread.Sleep(10 + (int) (20 * Rnd.NextDouble()));

        [Benchmark]
        public void RareDelays()
        {
            int rndTime = 10;
            // Bigger delays for 15% of the runs
            if (Rnd.NextDouble() &gt; 0.85)
            {
                rndTime += 30;
            }

            Thread.Sleep(rndTime);
        }
    }
}
</code></pre><h3 id="links">Links</h3>
<ul>
<li><a class="xref" href="../features/statistics.html">Statistics</a></li>
<li>The permanent link to this sample: <a class="xref" href="IntroPercentiles.html">Sample: IntroPercentiles</a></li>
</ul>
<hr>

</article>


        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top">
      <div class="container-xxl">
        <div class="flex-fill">
          Copyright &copy; 2013–2023 .NET Foundation and contributors
        </div>
      </div>
    </footer>
  </body>
</html>
