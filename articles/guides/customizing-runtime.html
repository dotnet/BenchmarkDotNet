<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Customizing Runtime | BenchmarkDotNet </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Customizing Runtime | BenchmarkDotNet ">
      
      
      <link rel="icon" href="../../logo/icon-32.png">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/dotnet/BenchmarkDotNet/blob/docs-stable/docs/articles/guides/customizing-runtime.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo/icon.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="docs.customizing-runtime">
<h1 id="customizing-runtime">Customizing Runtime</h1>

<p>Currently, we have only information about customizing Mono in this section.
If you want to customize .NET Core, read an article about <a class="xref" href="../configs/toolchains.html">Toolchains</a>.</p>
<hr>
<h2 id="sample-introcustommono">Sample: IntroCustomMono</h2>
<p>BenchmarkDotNet allows you to compare different runtimes, including Mono.
If you apply <code>[MonoJob]</code> attribute to your class we use your default mono runtime.
If you want to compare different versions of Mono you need to provide use the custom paths.
You can do this today by using the overloaded ctor of MonoJob attribute or by specifying the runtime in a fluent way.</p>
<p>The mono runtime can also operate as an ahead-of-time compiler. Using mono's AOT mode requires providing the AOT compilation
arguments, as well as the path to mono's corlib. (See IntroCustomMonoObjectStyleAot in the below example).</p>
<h3 id="source-code">Source code</h3>
<pre><code class="lang-csharp" name="IntroCustomMono.cs">using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Environments;
using BenchmarkDotNet.Jobs;
using BenchmarkDotNet.Running;

namespace BenchmarkDotNet.Samples
{
    // *** Attribute Style ***

    [MonoJob(&quot;Mono x64&quot;, @&quot;C:\Program Files\Mono\bin\mono.exe&quot;)]
    [MonoJob(&quot;Mono x86&quot;, @&quot;C:\Program Files (x86)\Mono\bin\mono.exe&quot;)]
    public class IntroCustomMono
    {
        [Benchmark]
        public void Foo()
        {
            // Benchmark body
        }
    }

    // *** Object Style ***

    [Config(typeof(Config))]
    public class IntroCustomMonoObjectStyle
    {
        private class Config : ManualConfig
        {
            public Config()
            {
                AddJob(Job.ShortRun.WithRuntime(new MonoRuntime(
                    &quot;Mono x64&quot;, @&quot;C:\Program Files\Mono\bin\mono.exe&quot;)));
                AddJob(Job.ShortRun.WithRuntime(new MonoRuntime(
                    &quot;Mono x86&quot;, @&quot;C:\Program Files (x86)\Mono\bin\mono.exe&quot;)));
            }
        }

        [Benchmark]
        public void Foo()
        {
            // Benchmark body
        }
    }

    // ** Object Style, Using AOT **

    [Config(typeof(Config))]
    public class IntroCustomMonoObjectStyleAot
    {
        private class Config : ManualConfig
        {
            public void AddMono (string name, string mono_top_dir)
            {
                var aot_compile_args  = &quot;--aot=llvm&quot;;
                var mono_bcl = $@&quot;{mono_top_dir}\lib\mono\4.5&quot;;
                var mono_bin = $@&quot;{mono_top_dir}\bin\mono.exe&quot;;
                AddJob(Job.ShortRun.WithRuntime(new MonoRuntime(
                    name, mono_bin, aot_compile_args, mono_bcl)));
            }

            public Config()
            {
                AddMono(&quot;Mono x64&quot;, @&quot;C:\Program Files\Mono&quot;);
                AddMono(&quot;Mono x86&quot;, @&quot;C:\Program Files (x86)\Mono&quot;);
            }
        }

        [Benchmark]
        public void Foo()
        {
            // Benchmark body
        }
    }

    // *** Fluent Config ***

    public class IntroCustomMonoFluentConfig
    {
        public static void Run()
        {
            BenchmarkRunner.Run&lt;IntroCustomMonoFluentConfig&gt;(ManualConfig
                .CreateMinimumViable()
                .AddJob(Job.ShortRun.WithRuntime(new MonoRuntime(
                    &quot;Mono x64&quot;, @&quot;C:\Program Files\Mono\bin\mono.exe&quot;)))
                .AddJob(Job.ShortRun.WithRuntime(new MonoRuntime(
                    &quot;Mono x86&quot;, @&quot;C:\Program Files (x86)\Mono\bin\mono.exe&quot;))));
        }

        [Benchmark]
        public void Foo()
        {
            // Benchmark body
        }
    }
}
</code></pre><h3 id="links">Links</h3>
<ul>
<li><a class="xref" href="customizing-runtime.html">Customizing Runtime</a></li>
<li>The permanent link to this sample: <a class="xref" href="../samples/IntroCustomMono.html">BenchmarkDotNet.Samples.IntroCustomMono</a></li>
</ul>
<hr>
<h2 id="sample-introcustommonoarguments">Sample: IntroCustomMonoArguments</h2>
<h3 id="source-code">Source code</h3>
<pre><code class="lang-csharp" name="IntroCustomMonoArguments.cs">using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Environments;
using BenchmarkDotNet.Jobs;

namespace BenchmarkDotNet.Samples
{
    [Config(typeof(ConfigWithCustomArguments))]
    public class IntroCustomMonoArguments
    {
        public class ConfigWithCustomArguments : ManualConfig
        {
            public ConfigWithCustomArguments()
            {
                // --optimize=MODE , -O=mode
                // MODE is a comma separated list of optimizations. They also allow
                // optimizations to be turned off by prefixing the optimization
                // name with a minus sign.

                AddJob(Job.Default
                    .WithRuntime(MonoRuntime.Default)
                    .WithArguments(new[] { new MonoArgument(&quot;--optimize=inline&quot;) })
                    .WithId(&quot;Inlining enabled&quot;));
                AddJob(Job.Default
                    .WithRuntime(MonoRuntime.Default)
                    .WithArguments(new[] { new MonoArgument(&quot;--optimize=-inline&quot;) })
                    .WithId(&quot;Inlining disabled&quot;));
            }
        }

        [Benchmark]
        public void Sample()
        {
            ShouldGetInlined(); ShouldGetInlined(); ShouldGetInlined();
            ShouldGetInlined(); ShouldGetInlined(); ShouldGetInlined();
            ShouldGetInlined(); ShouldGetInlined(); ShouldGetInlined();
        }

        private void ShouldGetInlined() { }
    }
}
</code></pre><h3 id="output">Output</h3>
<pre><code class="lang-markdown">| Method |               Job |          Arguments |       Mean |    StdDev |
|------- |------------------ |------------------- |-----------:|----------:|
| Sample | Inlining disabled | --optimize=-inline | 19.4252 ns | 0.4525 ns |
| Sample |  Inlining enabled |  --optimize=inline |  0.0000 ns | 0.0000 ns |
</code></pre>
<h3 id="links">Links</h3>
<ul>
<li><a class="xref" href="customizing-runtime.html">Customizing Runtime</a></li>
<li>The permanent link to this sample: <a class="xref" href="../samples/IntroCustomMonoArguments.html">BenchmarkDotNet.Samples.IntroCustomMonoArguments</a></li>
</ul>
<hr>
<h2 id="sample-introenvvars">Sample: IntroEnvVars</h2>
<p>You can configure custom environment variables for the process that is running your benchmarks.
One reason for doing this might be checking out how different
<a href="https://learn.microsoft.com/dotnet/core/runtime-config/compilation">compilation</a>,
<a href="https://learn.microsoft.com/dotnet/core/runtime-config/threading">threading</a>,
<a href="https://learn.microsoft.com/dotnet/core/runtime-config/garbage-collector">garbage collector</a>
settings affect the performance of .NET Core.</p>
<h3 id="source-code">Source code</h3>
<pre><code class="lang-csharp" name="IntroEnvVars.cs">using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Environments;
using BenchmarkDotNet.Jobs;

namespace BenchmarkDotNet.Samples
{
    [Config(typeof(ConfigWithCustomEnvVars))]
    public class IntroEnvVars
    {
        private class ConfigWithCustomEnvVars : ManualConfig
        {
            private const string JitNoInline = &quot;COMPlus_JitNoInline&quot;;

            public ConfigWithCustomEnvVars()
            {
                AddJob(Job.Default.WithRuntime(CoreRuntime.Core21).WithId(&quot;Inlining enabled&quot;));
                AddJob(Job.Default.WithRuntime(CoreRuntime.Core21)
                    .WithEnvironmentVariables(new EnvironmentVariable(JitNoInline, &quot;1&quot;))
                    .WithId(&quot;Inlining disabled&quot;));
            }
        }

        [Benchmark]
        public void Foo()
        {
            // Benchmark body
        }
    }
}
</code></pre><h3 id="links">Links</h3>
<ul>
<li><a class="xref" href="customizing-runtime.html">Customizing Runtime</a></li>
<li><a class="xref" href="../configs/configs.html">Configs</a></li>
<li><a class="xref" href="../configs/jobs.html">Jobs</a></li>
<li>The permanent link to this sample: <a class="xref" href="../samples/IntroEnvVars.html">BenchmarkDotNet.Samples.IntroEnvVars</a></li>
</ul>
<hr>
<h2 id="sample-introstathread">Sample: IntroStaThread</h2>
<p>If the code you want to benchmark requires <code>[System.STAThread]</code>
then you need to apply this attribute to the benchmarked method.
BenchmarkDotNet will generate an executable with <code>[STAThread]</code> applied to its <code>Main</code> method.</p>
<p>Using this feature on .NET Core requires .NET Core 2.1 or newer. Older versions will not work due to <a href="https://github.com/dotnet/runtime/issues/8834">this</a> bug.</p>
<h3 id="source-code">Source code</h3>
<pre><code class="lang-csharp" name="IntroStaThread.cs">using System.Threading;
using BenchmarkDotNet.Attributes;

namespace BenchmarkDotNet.Samples
{
    public class IntroStaThread
    {
        [Benchmark, System.STAThread]
        public void CheckForSTA()
        {
            if (Thread.CurrentThread.GetApartmentState() != ApartmentState.STA)
            {
                throw new ThreadStateException(
                    &quot;The current threads apartment state is not STA&quot;);
            }
        }
    }
}
</code></pre><h3 id="links">Links</h3>
<ul>
<li><a class="xref" href="customizing-runtime.html">Customizing Runtime</a></li>
<li>The permanent link to this sample: <a class="xref" href="../samples/IntroStaThread.html">BenchmarkDotNet.Samples.IntroStaThread</a></li>
</ul>
<hr>

</article>


        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Copyright &copy; 2013–2024 .NET Foundation and contributors
        </div>
      </div>
    </footer>
  </body>
</html>
